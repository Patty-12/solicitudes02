<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">

<h:head>
    <title>Formulario de Autorización</title>

    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            font-size: 11px;
            margin: 20px;
        }

        .page {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
        }

        .top-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .btn-volver {
            background: #607D8B;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 13px;
        }

        .btn-volver:hover {
            background: #78909C;
        }

        .btn-pdf {
            background: #1E88E5;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 13px;
        }

        .btn-pdf:hover {
            background: #1565C0;
        }

        .header-logo {
            width: 120px;
        }

        .title-center {
            text-align: center;
            font-weight: bold;
            text-transform: uppercase;
        }

        table.form-main {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .form-main th,
        .form-main td {
            border: 1px solid #000;
            padding: 4px 6px;
        }

        .form-main th {
            background: #e6e6e6;
            font-weight: bold;
        }

        .subsection-title {
            font-weight: bold;
            text-transform: uppercase;
            padding: 4px 0;
            margin-top: 10px;
        }

        .small-text {
            font-size: 10px;
        }

        .firma-box {
            height: 60px;
        }

        .center {
            text-align: center;
        }

        .checkbox-cell {
            width: 20px;
            text-align: center;
        }

        .file-upload-inline {
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</h:head>

<h:body>

<f:metadata>
    <f:viewParam name="id" value="#{solicitudDetalleBean.id}" />
    <f:event type="preRenderView" listener="#{solicitudDetalleBean.cargar}" />
</f:metadata>

<h:form id="formFormato" enctype="multipart/form-data">

    <div class="page">

        <!-- Botonera superior -->
        <div class="top-actions">

            <!-- TODO EXCEPTO RESPONSABLE DE ACCESOS -->
            <h:panelGroup rendered="#{not solicitudDetalleBean.responsablePuedeAplicarPermisosPublic}">

                <!-- Volver -->
                <h:link outcome="/Solicitud/index.xhtml" styleClass="btn-volver">
                    ← Volver
                </h:link>

                <!-- Botón imprimir SOLO mientras no existe PDF aún -->
                <h:outputLink value="#"
                              styleClass="btn-pdf"
                              rendered="#{empty solicitudDetalleBean.urlPdfActual}">
                    Imprimir formulario
                    <f:passThroughAttribute name="onclick"
                                            value="window.print();return false;" />
                </h:outputLink>

                <!-- FileUpload clásico + botón Subir -->
                <h:panelGroup
                        rendered="#{solicitudDetalleBean.mostrarAccionesSolicitantePublic
                                   or solicitudDetalleBean.directorPuedeFirmarPublic
                                   or solicitudDetalleBean.directorTicPuedeFirmarPublic
                                   or solicitudDetalleBean.oficialPuedeFirmarPublic}">

                    <div class="file-upload-inline">
                        <!-- input típico gris del navegador -->
                        <p:fileUpload value="#{solicitudDetalleBean.archivoFirmado}"
                                      mode="simple"
                                      allowTypes="/(\.|\/)(pdf)$/"/>
                        <!-- botón que realmente sube -->
                        <p:commandButton value="Subir PDF firmado"
                                         icon="pi pi-upload"
                                         actionListener="#{solicitudDetalleBean.subirFirmado}"
                                         update="@form"/>
                    </div>
                </h:panelGroup>

                <!-- ACCIONES DEL SOLICITANTE -->
                <h:panelGroup rendered="#{solicitudDetalleBean.mostrarAccionesSolicitantePublic}">
                    <p:commandButton value=" Enviar al Director"
                                     icon="pi pi-send"
                                     actionListener="#{solicitudDetalleBean.enviarAlDirector}"
                                     update="@form"
                                     styleClass="ui-button-primary" />
                </h:panelGroup>

                <!-- ACCIONES DEL DIRECTOR -->
                <h:panelGroup rendered="#{solicitudDetalleBean.directorPuedeFirmarPublic}">
                    <p:commandButton value=" Aprobar (Director)"
                                     icon="pi pi-check"
                                     styleClass="ui-button-success"
                                     actionListener="#{solicitudDetalleBean.aprobarComoDirector}"
                                     update="@form"
                                     onclick="return confirm('¿Aprobar la solicitud como Director?');" />

                    <p:commandButton value=" Rechazar (Director)"
                                     icon="pi pi-times"
                                     styleClass="ui-button-danger"
                                     actionListener="#{solicitudDetalleBean.rechazarComoDirector}"
                                     update="@form"
                                     onclick="return confirm('¿Rechazar la solicitud como Director?');" />
                </h:panelGroup>

                <!-- ACCIONES DEL DIRECTOR TIC -->
                <h:panelGroup rendered="#{solicitudDetalleBean.directorTicPuedeFirmarPublic}">

                    <!-- Camino 1: Director TIC aprueba y envía al Oficial de Seguridad -->
                    <p:commandButton value="Aprobar y enviar a Oficial de Seguridad"
                                     icon="pi pi-check"
                                     styleClass="ui-button-success"
                                     actionListener="#{solicitudDetalleBean.aprobarComoDirectorTicEnviarOficial}"
                                     update="@form"
                                     onclick="return confirm('¿Aprobar la solicitud como Director TIC y enviarla al Oficial de Seguridad?');" />

                    <!-- Camino 2: Director TIC termina flujo técnico y pasa directo a Responsable de Accesos -->
                    <p:commandButton value="Aprobar y enviar a Responsable de Accesos"
                                     icon="pi pi-arrow-right-arrow-left"
                                     styleClass="ui-button-info"
                                     actionListener="#{solicitudDetalleBean.aprobarComoDirectorTicSinOficial}"
                                     update="@form"
                                     onclick="return confirm('¿Aprobar la solicitud como Director TIC y enviarla directamente al Responsable de Accesos (sin pasar por Oficial de Seguridad)?');" />

                    <p:commandButton value=" Rechazar (Director TIC)"
                                     icon="pi pi-times"
                                     styleClass="ui-button-danger"
                                     actionListener="#{solicitudDetalleBean.rechazarComoDirectorTic}"
                                     update="@form"
                                     onclick="return confirm('¿Rechazar la solicitud como Director TIC?');" />
                </h:panelGroup>

                <!-- ACCIONES DEL OFICIAL DE SEGURIDAD -->
                <h:panelGroup rendered="#{solicitudDetalleBean.oficialPuedeFirmarPublic}">
                    <p:commandButton value=" Aprobar (Oficial Seguridad)"
                                     icon="pi pi-check"
                                     styleClass="ui-button-success"
                                     actionListener="#{solicitudDetalleBean.aprobarComoOficial}"
                                     update="@form"
                                     onclick="return confirm('¿Aprobar la solicitud como Oficial de Seguridad?');" />

                    <p:commandButton value=" Rechazar (Oficial Seguridad)"
                                     icon="pi pi-times"
                                     styleClass="ui-button-danger"
                                     actionListener="#{solicitudDetalleBean.rechazarComoOficial}"
                                     update="@form"
                                     onclick="return confirm('¿Rechazar la solicitud como Oficial de Seguridad?');" />
                </h:panelGroup>

            </h:panelGroup>

            <!-- ACCIONES DEL RESPONSABLE DE ACCESOS -->
            <h:panelGroup rendered="#{solicitudDetalleBean.responsablePuedeAplicarPermisosPublic}">
                <p:commandButton value=" Marcar permisos aplicados"
                                 icon="pi pi-check"
                                 styleClass="ui-button-help"
                                 actionListener="#{solicitudDetalleBean.marcarPermisosAplicados}"
                                 update="@form"
                                 onclick="return confirm('¿Confirmar que los permisos ya fueron aplicados en los sistemas reales?');" />
            </h:panelGroup>

        </div>

        <!-- MENSAJES -->
        <p:messages id="msgs" showDetail="true" closable="true" autoUpdate="true" />

        <!-- VISTA PREVIA DEL PDF EN IFRAME (cuando exista cualquier versión) -->
        <h:panelGroup rendered="#{not empty solicitudDetalleBean.urlPdfActual}">
            <h3>Vista previa del formulario (PDF)</h3>
            <iframe src="#{solicitudDetalleBean.urlPdfActual}"
                    style="width:100%; height:800px; border:1px solid #ccc;"></iframe>
        </h:panelGroup>

        <!-- ===== FORMULARIO HTML SOLO SI NO HAY NINGÚN PDF ===== -->
        <h:panelGroup rendered="#{empty solicitudDetalleBean.urlPdfActual}">

            <!-- ENCABEZADO SIMPLE CON LOGO -->
            <table style="width:100%; border-collapse:collapse; margin-top:10px;">
                <tr>
                    <td style="width:25%; text-align:left;">
                        <h:graphicImage library="img" name="logo.png"
                                        styleClass="header-logo" alt="Logo"/>
                    </td>
                    <td style="text-align:center;">
                        <div class="title-center">
                            SERVICIO NACIONAL DE DERECHOS INTELECTUALES<br/>
                            DIRECCIÓN DE TECNOLOGÍAS DE LA INFORMACIÓN Y COMUNICACIÓN<br/>
                            FORMULARIO DE AUTORIZACIÓN A SISTEMAS Y APLICACIONES
                        </div>
                    </td>
                    <td style="width:25%;"></td>
                </tr>
            </table>

            <!-- FECHA DE SOLICITUD (sin estado en el PDF) -->
            <table class="form-main">
                <tr>
                    <th style="width:25%;">Fecha de solicitud</th>
                    <td>#{solicitudDetalleBean.fechaSolicitudFormateada}</td>
                </tr>
            </table>

            <!-- DATOS SERVIDOR SOLICITANTE -->
            <div class="subsection-title">DATOS DEL SERVIDOR SOLICITANTE</div>
            <table class="form-main">
                <tr>
                    <th style="width:20%;">Nombres</th>
                    <td style="width:30%;">#{solicitudDetalleBean.servidorSolicitante.nombre}</td>
                    <th style="width:20%;">Apellidos</th>
                    <td style="width:30%;">#{solicitudDetalleBean.servidorSolicitante.apellido}</td>
                </tr>
                <tr>
                    <th>Unidad/Sección</th>
                    <td>#{solicitudDetalleBean.servidorSolicitante.unidadGestion}</td>
                    <th>Cargo</th>
                    <td>#{solicitudDetalleBean.servidorSolicitante.cargo}</td>
                </tr>
                <tr>
                    <th>Correo institucional</th>
                    <td>#{solicitudDetalleBean.servidorSolicitante.correo}</td>
                    <th>Teléfono / Extensión</th>
                    <td>
                        <!-- #{solicitudDetalleBean.servidorSolicitante.telefono} -->
                    </td>
                </tr>
            </table>

            <!-- DATOS SERVIDOR QUE AUTORIZA (Director área) -->
            <div class="subsection-title">DATOS DEL SERVIDOR QUE AUTORIZA</div>
            <table class="form-main">
                <tr>
                    <th style="width:20%;">Nombres</th>
                    <td style="width:30%;">
                        #{empty solicitudDetalleBean.servidorAutoriza
                          ? '' : solicitudDetalleBean.servidorAutoriza.nombre}
                    </td>
                    <th style="width:20%;">Apellidos</th>
                    <td style="width:30%;">
                        #{empty solicitudDetalleBean.servidorAutoriza
                          ? '' : solicitudDetalleBean.servidorAutoriza.apellido}
                    </td>
                </tr>
                <tr>
                    <th>Unidad/Sección</th>
                    <td>
                        #{empty solicitudDetalleBean.servidorAutoriza
                          ? '' : solicitudDetalleBean.servidorAutoriza.unidadGestion}
                    </td>
                    <th>Cargo</th>
                    <td>
                        #{empty solicitudDetalleBean.servidorAutoriza
                          ? '' : solicitudDetalleBean.servidorAutoriza.cargo}
                    </td>
                </tr>
                <tr>
                    <th>Correo institucional</th>
                    <td>
                        #{empty solicitudDetalleBean.servidorAutoriza
                          ? '' : solicitudDetalleBean.servidorAutoriza.correo}
                    </td>
                    <th>Teléfono / Extensión</th>
                    <td>
                        <!-- #{empty solicitudDetalleBean.servidorAutoriza
                                 ? '' : solicitudDetalleBean.servidorAutoriza.telefono} -->
                    </td>
                </tr>
            </table>

            <!-- SISTEMAS INTERNOS SENADI -->
            <div class="subsection-title">SISTEMAS INTERNOS SENADI</div>

            <table class="form-main">
                <tr>
                    <th style="width:30%;">SISTEMA / APLICACIÓN</th>
                    <th>Descripción</th>
                    <th class="checkbox-cell">X</th>
                </tr>

                <ui:repeat value="#{solicitudDetalleBean.accesos}" var="acc">
                    <tr>
                        <td>#{acc.permiso.aplicacion.nombre}</td>
                        <td>#{acc.permiso.nombre}</td>
                        <td class="checkbox-cell">X</td>
                    </tr>
                </ui:repeat>
            </table>

            <!-- TEXTO LEGAL -->
            <h4>VALIDACIÓN Y COMPROMISO DE USO DE ACCESOS A SISTEMAS INSTITUCIONALES – SENADI:</h4>

            <p class="small-text" style="margin-top:10px; text-align:justify;">
                Los accesos y permisos solicitados a los sistemas institucionales serán validados por la Dirección de TICs, con la
                firma de responsabilidad correspondiente. Posteriormente, el Oficial de Seguridad de la Información firmará en
                señal de aprobación.
            </p>
            <p class="small-text" style="margin-top:10px; text-align:justify;">
                El usuario autorizador es responsable de verificar que los accesos solicitados por el usuario correspondan al perfil
                para el cual fue contratado. Asimismo, deberá controlar que el uso del sistema institucional y de la información a la
                que tenga acceso el usuario sea adecuado, ético y conforme con la normativa legal vigente.
            </p>
            <p class="small-text" style="margin-top:10px; text-align:justify;">
                Mediante el presente documento, el usuario solicitante se compromete a hacer un uso responsable y ético,
                enmarcado en las políticas institucionales y la normativa vigente. El formulario será válido únicamente si cuenta con
                todas las firmas requeridas, debidamente suscritas por el solicitante y su jefe inmediato.
            </p>
            <p class="small-text" style="margin-top:10px; text-align:justify;">
                Disposición técnica sobre la forma de presentación del formulario: El formulario obligatoriamente debe
                ser llenado digitalmente, es decir todas las firmas deberán ser electrónicas.
            </p>

            <h4>
                Nota: En caso de detectarse un uso indebido de los accesos concedidos, el perfil del usuario será bloqueado de
                forma inmediata, sin necesidad de notificación previa.
            </h4>

            <!-- FIRMAS -->
            <div class="subsection-title">FIRMAS DE RESPONSABILIDAD</div>
            <table class="form-main">
                <tr>
                    <th class="center">SERVIDOR QUE SOLICITA</th>
                    <th class="center">JEFE INMEDIATO</th>
                </tr>
                <tr class="firma-box">
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td class="center small-text">Nombre / Firma</td>
                    <td class="center small-text">Nombre / Firma</td>
                </tr>
            </table>

            <div class="subsection-title">VALIDACIÓN TÉCNICA</div>
            <table class="form-main">
                <tr>
                    <th class="center">DIRECCIÓN DE TECNOLOGÍAS DE LA INFORMACIÓN Y COMUNICACIÓN</th>
                </tr>
                <tr class="firma-box">
                    <td></td>
                </tr>
                <tr>
                    <td class="center small-text">Nombre / Firma</td>
                </tr>
            </table>

            <div class="subsection-title">APROBACIÓN</div>
            <table class="form-main">
                <tr>
                    <th class="center">OFICIAL DE SEGURIDAD DE LA INFORMACIÓN</th>
                </tr>
                <tr class="firma-box">
                    <td></td>
                </tr>
                <tr>
                    <td class="center small-text">Nombre / Firma</td>
                </tr>
            </table>

        </h:panelGroup>
        <!-- ===== FIN FORMULARIO HTML ===== -->

        <!-- HISTORIAL DE FIRMAS (siempre visible) -->
        <div class="subsection-title">HISTORIAL DE FIRMAS</div>

        <p:dataTable value="#{solicitudDetalleBean.firmasOrdenadas}"
                     var="f"
                     emptyMessage="Aún no existen firmas registradas"
                     style="margin-top:5px;">

            <p:column headerText="Fecha / Hora" style="width:200px;">
                #{solicitudDetalleBean.formatearFechaHora(f.fechaFirma)}
            </p:column>

            <p:column headerText="Detalle">
                #{f.descripcion}
            </p:column>

        </p:dataTable>

    </div>

</h:form>

</h:body>
</html>
