<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="/templates/layout.xhtml">

    <f:metadata>
        <f:event type="preRenderView" listener="#{loginBean.verificarSesion}" />
        <!-- Sólo inicializa la primera vez, gracias al isPostback dentro de prepararNuevo() -->
        <f:event type="preRenderView" listener="#{solicitudBean.prepararNuevo}" />
    </f:metadata>

    <ui:define name="titulo">Nueva Solicitud</ui:define>

    <ui:define name="contenido">

        <!-- Estilos locales para tabla zebra y tabla de director -->
        <style>
            .tabla-director {
                width: 100%;
                border-collapse: collapse;
                margin-top: 0.5rem;
            }
            .tabla-director th,
            .tabla-director td {
                border: 1px solid #e0e0e0;
                padding: 6px 8px;
                text-align: left;
            }
            .tabla-director th {
                background: #f5f5f5;
                font-weight: 600;
            }

            .tabla-permisos {
                width: 100%;
                border-collapse: collapse;
                margin-top: 0.5rem;
            }
            .tabla-permisos th,
            .tabla-permisos td {
                padding: 4px 8px;
                border-bottom: 1px solid #e0e0e0;
            }
            .tabla-permisos thead th {
                background: #f5f5f5;
                font-weight: 600;
            }
            .tabla-permisos tbody tr:nth-child(odd) {
                background: #ffffff;
            }
            .tabla-permisos tbody tr:nth-child(even) {
                background: #f9fbff;
            }
            .perm-check-cell {
                text-align: center;
            }
        </style>

        <h:form id="formSolicitud">

            <p:messages id="msgs" showDetail="true" closable="true" autoUpdate="true" />

            <div>

                <!-- CABECERA -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h3 style="margin:0;">Formulario de Autorización a Sistemas y Aplicaciones</h3>

                    <p:button outcome="/Solicitud/index.xhtml"
                              value=" Volver"
                              icon="pi pi-arrow-left"
                              styleClass="ui-button-secondary btn-cancelar" />
                </div>

                <p:separator style="margin:0.5rem 0 1rem 0;" />

                <!-- SISTEMAS INTERNOS SENADI (TABLA ZEBRA) -->
                <p:panel header="SISTEMAS INTERNOS SENADI"
                         style="margin-bottom:1rem;"
                         styleClass="panel-claro">

                    <p style="font-size:13px; margin-bottom:0.5rem;">
                        SISTEMA / APLICACIÓN  |  ACCESOS / PERMISOS (Marque el casillero correspondiente).
                    </p>

                    <!-- Filtro -->
                    <h:panelGrid columns="2"
                                 columnClasses="col-label, col-value"
                                 style="margin-bottom:0.8rem; width:100%;">
                        <h:outputLabel for="filtroPermisos" value="Filtrar:" />
                        <h:inputText id="filtroPermisos"
                                     onkeyup="filtrarPermisos()"
                                     style="width:260px;"
                                     placeholder="Escriba parte del sistema o permiso..." />
                    </h:panelGrid>

                    <!-- TABLA UNIFICADA -->
                    <table class="tabla-permisos">
                        <thead>
                            <tr>
                                <th style="width:220px;">Sistema / Aplicación</th>
                                <th>Acceso / Permiso</th>
                                <th style="width:100px; text-align:center;">Seleccionar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <ui:repeat value="#{solicitudBean.aplicaciones}" var="app">
                                <ui:repeat value="#{app.permisos}" var="perm">
                                    <tr>
                                        <td>#{app.nombre}</td>
                                        <td>
                                            #{perm.nombre}
                                            <h:outputText value=" - #{perm.descripcion}"
                                                          rendered="#{not empty perm.descripcion}" />
                                        </td>
                                        <td class="perm-check-cell">
                                            <h:selectBooleanCheckbox
                                                value="#{solicitudBean.permisosSeleccionados[perm.id]}" />
                                        </td>
                                    </tr>
                                </ui:repeat>
                            </ui:repeat>
                        </tbody>
                    </table>

                </p:panel>

                <p:separator style="margin:0.5rem 0 1rem 0;" />

                <!-- DATOS DEL SERVIDOR QUE AUTORIZA (DIRECTOR) -->
                <p:panel header="DATOS DEL SERVIDOR QUE AUTORIZA"
                         style="margin-bottom:1rem;"
                         styleClass="panel-claro">

                    <!-- AUTOCOMPLETE / LISTA DE DIRECTORES -->
                    <h:panelGrid columns="2"
                                 columnClasses="col-label, col-input"
                                 style="width:100%; margin-bottom:0.5rem;">
                        <h:outputLabel for="director" value="Director que autoriza:" />

                        <p:autoComplete id="director"
                                        value="#{solicitudBean.idDirectorSeleccionado}"
                                        completeMethod="#{solicitudBean.completarDirectores}"
                                        var="dir"
                                        itemLabel="#{dir.nombre} #{dir.apellido} - #{dir.unidadGestion}"
                                        itemValue="#{dir.id}"
                                        dropdown="true"
                                        forceSelection="true"
                                        cache="true"
                                        minQueryLength="0"
                                        autoSelection="false"
                                        style="width:100%;" />
                    </h:panelGrid>

                    <!-- Tabla de datos del director: campos frente a frente -->
                    <table class="tabla-director">
                        <tbody>
                            <tr>
                                <th style="width:20%;">Nombres</th>
                                <td style="width:30%;">
                                    #{empty solicitudBean.jefe ? '' : solicitudBean.jefe.nombre}
                                </td>
                                <th style="width:20%;">Apellidos</th>
                                <td style="width:30%;">
                                    #{empty solicitudBean.jefe ? '' : solicitudBean.jefe.apellido}
                                </td>
                            </tr>
                            <tr>
                                <th>Unidad/Sección</th>
                                <td>
                                    #{empty solicitudBean.jefe ? '' : solicitudBean.jefe.unidadGestion}
                                </td>
                                <th>Cargo</th>
                                <td>
                                    #{empty solicitudBean.jefe ? '' : solicitudBean.jefe.cargo}
                                </td>
                            </tr>
                            <tr>
                                <th>Correo institucional</th>
                                <td>
                                    #{empty solicitudBean.jefe ? '' : solicitudBean.jefe.correo}
                                </td>
                                <th>Teléfono / Extensión</th>
                                <td>
                                    #{empty solicitudBean.jefe ? '' : solicitudBean.jefe.telefono}
                                </td>
                            </tr>
                        </tbody>
                    </table>

                </p:panel>

                <!-- BOTONES -->
                <div style="display:flex; justify-content:flex-end; gap:0.7rem; margin-top:1rem;">

                    <p:button outcome="/Solicitud/index.xhtml"
                              value=" Cancelar"
                              icon="pi pi-times"
                              styleClass="ui-button-secondary btn-cancelar" />

                    <p:commandButton value=" Guardar"
                                     icon="pi pi-save"
                                     action="#{solicitudBean.guardar}"
                                     ajax="false"
                                     styleClass="ui-button-success btn-guardar" />
                </div>

            </div>

            <!-- Script de filtro en cliente -->
            <h:outputScript target="body">
                function filtrarPermisos() {
                    var input = document.getElementById('formSolicitud:filtroPermisos');
                    if (!input) return;
                    var filtro = input.value.toLowerCase();
                    var filas = document.querySelectorAll('#formSolicitud .tabla-permisos tbody tr');
                    filas.forEach(function(tr) {
                        var sistema = tr.cells[0].textContent.toLowerCase();
                        var permiso = tr.cells[1].textContent.toLowerCase();
                        if (sistema.indexOf(filtro) > -1 || permiso.indexOf(filtro) > -1) {
                            tr.style.display = '';
                        } else {
                            tr.style.display = 'none';
                        }
                    });
                }
            </h:outputScript>

        </h:form>

    </ui:define>

</ui:composition>
