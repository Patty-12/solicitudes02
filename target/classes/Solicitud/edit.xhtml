<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="/templates/layout.xhtml">

    <!-- Verificar sesiÃ³n y cargar solicitud -->
    <f:metadata>
        <f:event type="preRenderView" listener="#{loginBean.verificarSesion}" />
        <f:viewParam name="id" value="#{solicitudBean.idSolicitud}" />
        <f:event type="preRenderView" listener="#{solicitudBean.cargarSolicitud}" />
    </f:metadata>

    <ui:define name="titulo">Editar Solicitud</ui:define>

    <ui:define name="contenido">

        <h:form id="formSolicitudEdit">

            <!-- MENSAJES -->
            <p:messages id="msgs"
                        showDetail="true"
                        closable="true"
                        autoUpdate="true" />

            <div class="card">

                <!-- CABECERA -->
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Editar Solicitud # #{solicitudBean.formulario.id}</h3>

                    <h:link outcome="/Solicitud/index.xhtml"
                            value="Volver a la lista"
                            styleClass="ui-button ui-button-secondary" />
                </div>

                <hr/>

                <!-- DATOS DEL SERVIDOR SOLICITANTE -->
                <h4>Datos del servidor solicitante</h4>

                <h:panelGrid columns="2" columnClasses="col-label,col-value"
                             style="width:100%; margin-bottom:1rem;">
                    <h:outputText value="Nombres:" />
                    <h:outputText value="#{solicitudBean.formulario.usuario.nombre}" />

                    <h:outputText value="Apellidos:" />
                    <h:outputText value="#{solicitudBean.formulario.usuario.apellido}" />

                    <h:outputText value="Cargo:" />
                    <h:outputText value="#{solicitudBean.formulario.usuario.cargo}" />

                    <h:outputText value="Correo institucional:" />
                    <h:outputText value="#{solicitudBean.formulario.usuario.correo}" />

                    <h:outputText value="Estado actual:" />
                    <h:outputText value="#{solicitudBean.formulario.estado}" />
                </h:panelGrid>

                <!-- DATOS DEL SERVIDOR QUE AUTORIZA -->
                <h4>Datos del servidor que autoriza</h4>

                <h:panelGrid columns="2" columnClasses="col-label,col-value"
                             style="width:100%; margin-bottom:1rem;">
                    <h:outputLabel for="correoJefe" value="Correo del Director:" />
                    <h:panelGroup>
                        <h:inputText id="correoJefe"
                                     value="#{solicitudBean.correoJefe}"
                                     style="width:300px;" />
                        <p:commandButton value="Buscar jefe"
                                         actionListener="#{solicitudBean.llenarDatosJefe}"
                                         update="formSolicitudEdit"
                                         styleClass="ui-button-secondary"
                                         style="margin-left:0.5rem;" />
                    </h:panelGroup>

                    <h:outputText value="Nombre del Director:" />
                    <h:panelGroup rendered="#{solicitudBean.jefe ne null}">
                        <h:outputText value="#{solicitudBean.jefe.nombre} #{solicitudBean.jefe.apellido}" />
                    </h:panelGroup>
                </h:panelGrid>

                <!-- SISTEMAS Y PERMISOS -->
                <h4>Sistemas internos SENADI</h4>
                <p class="small-text">
                    Ajuste los permisos que mantiene esta solicitud.
                </p>

                <div class="sistemas-container">

                    <ui:repeat value="#{solicitudBean.aplicaciones}" var="app">

                        <h:panelGroup layout="block" style="margin-top:0.7rem;">
                            <strong>#{app.nombre}</strong>
                            <h:outputText value=" - #{app.descripcion}"
                                          rendered="#{not empty app.descripcion}" />
                        </h:panelGroup>

                        <ui:repeat value="#{app.permisos}" var="perm">
                            <h:panelGrid columns="2"
                                         columnClasses="col-perm-label,col-perm-check"
                                         style="width:100%; margin-left:1rem;">
                                <h:outputText value="#{perm.nombre} - #{perm.descripcion}" />
                                <h:selectBooleanCheckbox
                                        value="#{solicitudBean.permisosSeleccionados[perm.id]}" />
                            </h:panelGrid>
                        </ui:repeat>

                        <hr style="border:none; border-top:1px solid #e0e0e0;" />

                    </ui:repeat>

                </div>

                <!-- BOTONES -->
                <div style="margin-top:1rem; display:flex; justify-content:flex-end; gap:0.5rem;">
                    <h:link outcome="/Solicitud/index.xhtml"
                            value="Cancelar"
                            styleClass="ui-button ui-button-secondary" />

                    <p:commandButton value="Guardar cambios"
                                     action="#{solicitudBean.guardar}"
                                     update="formSolicitudEdit"
                                     styleClass="ui-button-primary" />
                </div>

            </div>

        </h:form>

    </ui:define>

</ui:composition>
