<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="/templates/layout.xhtml">

    <!-- Verifica sesión y carga la solicitud por id -->
    <f:metadata>
        <f:event type="preRenderView" listener="#{loginBean.verificarSesion}" />
        <f:viewParam name="id" value="#{solicitudBean.idSolicitud}" />
        <f:event type="preRenderView" listener="#{solicitudBean.cargarSolicitud}" />
    </f:metadata>

    <ui:define name="titulo">Editar Solicitud</ui:define>

    <ui:define name="contenido">

        <h:form id="formSolicitudEdit">

            <p:messages id="msgs"
                        showDetail="true"
                        closable="true"
                        autoUpdate="true" />

            <div>

                <!-- Cabecera -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h3 style="margin:0;">Editar Solicitud # #{solicitudBean.formulario.id}</h3>

                    <p:button outcome="/Solicitud/index.xhtml"
                              value=" Volver"
                              icon="pi pi-arrow-left"
                              styleClass="ui-button-secondary btn-cancelar" />
                </div>

                <p:separator style="margin:0.5rem 0 1rem 0;" />

                <!-- ============================================ -->
                <!-- SISTEMAS INTERNOS SENADI                     -->
                <!-- ============================================ -->
                <p:panel header="SISTEMAS INTERNOS SENADI"
                         style="margin-bottom:1rem;"
                         styleClass="panel-claro">

                    <p style="font-size:13px; margin-bottom:0.5rem;">
                        Ajuste los permisos que mantiene esta solicitud.
                    </p>

                    <h:panelGrid columns="2"
                                 columnClasses="col-label, col-value"
                                 style="margin-bottom:0.8rem;">
                        <h:outputLabel for="filtroPermisos" value="Filtrar:" />
                        <h:inputText id="filtroPermisos"
                                     onkeyup="filtrarPermisosEdit()"
                                     style="width:260px;"
                                     placeholder="Escriba parte del sistema o permiso..." />
                    </h:panelGrid>

                    <table class="tabla-permisos" id="tablaPermisosEdit">
                        <thead>
                            <tr>
                                <th style="width:220px;">Sistema / Aplicación</th>
                                <th>Acceso / Permiso</th>
                                <th style="width:100px; text-align:right;">Seleccionar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <ui:repeat value="#{solicitudBean.aplicaciones}" var="app">
                                <ui:repeat value="#{app.permisos}" var="perm">
                                    <tr>
                                        <td>#{app.nombre}</td>
                                        <td>
                                            #{perm.nombre}
                                            <h:outputText value=" - #{perm.descripcion}"
                                                          rendered="#{not empty perm.descripcion}" />
                                        </td>
                                        <td class="perm-check-cell">
                                            <h:selectBooleanCheckbox
                                                    value="#{solicitudBean.permisosSeleccionados[perm.id]}" />
                                        </td>
                                    </tr>
                                </ui:repeat>
                            </ui:repeat>
                        </tbody>
                    </table>

                </p:panel>

                <p:separator style="margin:0.5rem 0 1rem 0;" />

                <!-- ============================================ -->
                <!-- DATOS DEL SERVIDOR QUE AUTORIZA (edición)   -->
                <!-- ============================================ -->
                <p:panel header="DATOS DEL SERVIDOR QUE AUTORIZA"
                         style="margin-bottom:1rem;"
                         styleClass="panel-claro">

                    <h:panelGrid columns="1" style="width:100%; margin-bottom:0.8rem;">
                        <h:outputLabel for="nombreJefe" value="Buscar Director por nombre:" />

                        <h:panelGroup style="display:flex; align-items:center;">
                            <h:inputText id="nombreJefe"
                                         value="#{solicitudBean.nombreJefeBusqueda}"
                                         style="width:260px;" />

                            <p:commandButton value="Buscar"
                                             icon="pi pi-search"
                                             actionListener="#{solicitudBean.buscarDirectorPorNombre}"
                                             update="formSolicitudEdit"
                                             styleClass="ui-button-secondary btn-accion"
                                             style="margin-left:0.5rem;" />
                        </h:panelGroup>
                    </h:panelGrid>

                    <table class="tabla-datos-autoriza">
                        <thead>
                            <tr>
                                <th style="width:50%;">Nombres</th>
                                <th style="width:50%;">Apellidos</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <h:outputText value="#{solicitudBean.jefe.nombre}"
                                                  rendered="#{solicitudBean.jefe ne null}" />
                                </td>
                                <td>
                                    <h:outputText value="#{solicitudBean.jefe.apellido}"
                                                  rendered="#{solicitudBean.jefe ne null}" />
                                </td>
                            </tr>

                            <tr>
                                <td>Unidad/Sección</td>
                                <td>Cargo</td>
                            </tr>
                            <tr>
                                <td>
                                    <h:outputText value="#{solicitudBean.jefe.unidadGestion}"
                                                  rendered="#{solicitudBean.jefe ne null}" />
                                </td>
                                <td>
                                    <h:outputText value="#{solicitudBean.jefe.cargo}"
                                                  rendered="#{solicitudBean.jefe ne null}" />
                                </td>
                            </tr>

                            <tr>
                                <td>Correo institucional</td>
                                <td>Teléfono / Extensión</td>
                            </tr>
                            <tr>
                                <td>
                                    <h:outputText value="#{solicitudBean.jefe.correo}"
                                                  rendered="#{solicitudBean.jefe ne null}" />
                                </td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>

                </p:panel>

                <!-- Botones -->
                <div style="margin-top:1rem; display:flex; justify-content:flex-end; gap:0.7rem;">
                    <p:button outcome="/Solicitud/index.xhtml"
                              value=" Cancelar"
                              icon="pi pi-times"
                              styleClass="ui-button-secondary btn-cancelar" />

                    <p:commandButton value=" Guardar cambios"
                                     icon="pi pi-save"
                                     action="#{solicitudBean.guardar}"
                                     ajax="false"
                                     styleClass="ui-button-success btn-guardar" />
                </div>

            </div>

            <!-- Script de filtro en edición -->
            <h:outputScript target="body">
                function filtrarPermisosEdit() {
                    var input = document.getElementById('formSolicitudEdit:filtroPermisos');
                    if (!input) return;
                    var filtro = input.value.toLowerCase();

                    var tabla = document.querySelector('#formSolicitudEdit .tabla-permisos tbody');
                    if (!tabla) return;

                    var filas = tabla.querySelectorAll('tr');
                    filas.forEach(function(tr) {
                        var sistema = tr.cells[0].textContent.toLowerCase();
                        var permiso = tr.cells[1].textContent.toLowerCase();

                        if (sistema.indexOf(filtro) > -1 || permiso.indexOf(filtro) > -1) {
                            tr.style.display = '';
                        } else {
                            tr.style.display = 'none';
                        }
                    });
                }
            </h:outputScript>

        </h:form>

    </ui:define>

</ui:composition>
